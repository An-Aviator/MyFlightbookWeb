CREATE TABLE `logbook`.`clubs` (
  `idclub` INT NOT NULL AUTO_INCREMENT COMMENT 'The id for the club',
  `creator` VARCHAR(255) NOT NULL COMMENT 'User who created the club',
  `creationDate` DATETIME NOT NULL COMMENT 'Time stamp of creation',
  `clubname` VARCHAR(90) NOT NULL COMMENT 'The name for the club',
  `clubdesc` VARCHAR(1000) NULL COMMENT 'Description of the club\n',
  `clubURL` VARCHAR(255) NULL COMMENT 'Link to club URL, if any',
  `clubcity` VARCHAR(45) NULL COMMENT 'city where club is located',
  `clubStateProvince` VARCHAR(45) NULL COMMENT 'State or province where it is located',
  `clubCountry` VARCHAR(45) NULL COMMENT 'Country where the club is located',
  `clubContactPhone` VARCHAR(45) NULL COMMENT 'Contact phone number for the club',
  `clubHomeAirport` VARCHAR(45) NULL COMMENT 'Home airport for the club',
  PRIMARY KEY (`idclub`))
COMMENT = 'Table of flying clubs';

delimiter $$

CREATE TABLE `clubmembers` (
  `idclub` int(11) NOT NULL,
  `username` varchar(255) NOT NULL COMMENT 'Username for people, aircraft ID for aircraft',
  `role` int(11) DEFAULT '0' COMMENT '0 = Member\n1 = Admin\n2 = Owner\n',
  `joindate` datetime DEFAULT NULL COMMENT 'Date that this user joined the club',
  PRIMARY KEY (`username`,`idclub`),
  KEY `idclub_idx` (`idclub`),
  CONSTRAINT `idclub` FOREIGN KEY (`idclub`) REFERENCES `clubs` (`idclub`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Members of a club, keyed on username'$$

delimiter $$

CREATE TABLE `clubaircraft` (
  `idclub` int(11) NOT NULL COMMENT 'The club to which the aircraft belongs',
  `idaircraft` int(10) unsigned NOT NULL COMMENT 'The aircraft that belongs to the club.',
  `description` varchar(2048) DEFAULT NULL COMMENT 'Description of the aircraft, rates, etc.',
  PRIMARY KEY (`idclub`,`idaircraft`),
  KEY `idaircraft_idx` (`idaircraft`),
  CONSTRAINT `aircraftConstraint` FOREIGN KEY (`idaircraft`) REFERENCES `aircraft` (`idaircraft`) ON DELETE CASCADE ON UPDATE NO ACTION,
  CONSTRAINT `clubconstraint` FOREIGN KEY (`idclub`) REFERENCES `clubs` (`idclub`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Aircraft that belong to a given club'$$

ALTER TABLE `logbook`.`scheduledevents` ADD COLUMN `idclub` INT NULL DEFAULT -1 COMMENT 'The club for which this is associated'  AFTER `body` ;

/* fix to handle longer HTML */
ALTER TABLE `logbook`.`clubaircraft` 
CHANGE COLUMN `description` `description` TEXT NULL DEFAULT NULL COMMENT 'Description of the aircraft, rates, etc.' ;
ALTER TABLE `logbook`.`clubs` 
CHANGE COLUMN `clubdesc` `clubdesc` TEXT NULL DEFAULT NULL COMMENT 'Description of the club\n' ;

/* delete scheduled items when deleting a club */
ALTER TABLE `logbook`.`scheduledevents` 
  ADD CONSTRAINT `clubforevent`
  FOREIGN KEY (`idclub` )
  REFERENCES `logbook`.`clubs` (`idclub` )
  ON DELETE CASCADE
  ON UPDATE NO ACTION
, ADD INDEX `clubforevent` (`idclub` ASC) ;

ALTER TABLE `logbook`.`clubs` ADD COLUMN `clubTimeZoneID` VARCHAR(45) NOT NULL COMMENT 'ID of the timezone where the club is located, as defined by TimeZoneInfo'  AFTER `clubHomeAirport` , ADD COLUMN `clubTimeZoneOffset` INT NULL DEFAULT 0 COMMENT 'Timezone offset from UTC, in minutes, as a BACKUP for timezoneID (in case for some reason the timezoneID stops working)'  AFTER `clubTimeZoneID` ;


ALTER TABLE `logbook`.`clubs` ADD COLUMN `policyFlags` UNSIGNED INT NULL DEFAULT 0 COMMENT 'Bitmask of flags for various policies.'  AFTER `clubTimeZoneOffset` ;
